name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.0)'
        required: true

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: get-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm ci

      - name: Update version in tauri.conf.json
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          CONF_FILE="src-tauri/tauri.conf.json"
          TEMP_FILE=$(mktemp)

          # Perform the sed replacement
          sed "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" "$CONF_FILE" > "$TEMP_FILE"

          # Validate the resulting JSON
          if ! node -e "JSON.parse(require('fs').readFileSync('$TEMP_FILE', 'utf8'))"; then
            echo "ERROR: JSON validation failed after version update"
            echo "=== Temp file contents ==="
            cat "$TEMP_FILE"
            rm -f "$TEMP_FILE"
            exit 1
          fi

          # JSON is valid, move temp file to target
          mv "$TEMP_FILE" "$CONF_FILE"
          echo "Successfully updated version to $VERSION"

      - name: Build Tauri app
        run: npm run tauri build

      - name: List build outputs
        run: |
          echo "=== DMG files ==="
          find src-tauri/target/release/bundle -name "*.dmg" 2>/dev/null || echo "No DMG found"
          echo "=== App bundles ==="
          find src-tauri/target/release/bundle -name "*.app" -type d 2>/dev/null || echo "No .app found"
          echo "=== All bundle contents ==="
          ls -la src-tauri/target/release/bundle/ 2>/dev/null || echo "No bundle dir"
          ls -la src-tauri/target/release/bundle/macos/ 2>/dev/null || echo "No macos dir"
          ls -la src-tauri/target/release/bundle/dmg/ 2>/dev/null || echo "No dmg dir"

      - name: Prepare release artifacts
        id: prepare
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          WORKSPACE_DIR="${{ github.workspace }}"
          BUNDLE_DIR="${WORKSPACE_DIR}/src-tauri/target/release/bundle"

          # Find the DMG file (Tauri names it based on version and arch)
          DMG_FILE=$(find "${BUNDLE_DIR}/dmg" -name "*.dmg" 2>/dev/null | head -1)
          if [ -z "$DMG_FILE" ]; then
            echo "ERROR: No DMG file found in ${BUNDLE_DIR}/dmg"
            echo "Expected pattern: ${BUNDLE_DIR}/dmg/*.dmg"
            ls -la "${BUNDLE_DIR}/dmg" 2>/dev/null || echo "Directory does not exist"
            exit 1
          fi
          cp "$DMG_FILE" "${WORKSPACE_DIR}/Murmur_${VERSION}_macos.dmg"
          echo "dmg_path=Murmur_${VERSION}_macos.dmg" >> $GITHUB_OUTPUT

          # Find the .app bundle
          APP_DIR=$(find "${BUNDLE_DIR}/macos" -name "*.app" -type d 2>/dev/null | head -1)
          if [ -z "$APP_DIR" ]; then
            echo "ERROR: No .app bundle found in ${BUNDLE_DIR}/macos"
            echo "Expected pattern: ${BUNDLE_DIR}/macos/*.app"
            ls -la "${BUNDLE_DIR}/macos" 2>/dev/null || echo "Directory does not exist"
            exit 1
          fi

          # Create tar.gz using absolute paths (no cd required)
          APP_NAME=$(basename "$APP_DIR")
          tar -C "${BUNDLE_DIR}/macos" -czf "${WORKSPACE_DIR}/Murmur_${VERSION}_macos.app.tar.gz" "$APP_NAME"
          echo "app_tar_path=Murmur_${VERSION}_macos.app.tar.gz" >> $GITHUB_OUTPUT

          # Dynamically locate signature file based on the app bundle we found
          # Look for .tar.gz.sig files matching the app name pattern
          SIGNATURE=""
          SIG_FILE=$(find "${BUNDLE_DIR}/macos" -name "*.app.tar.gz.sig" 2>/dev/null | head -1)
          if [ -n "$SIG_FILE" ] && [ -f "$SIG_FILE" ]; then
            SIGNATURE=$(cat "$SIG_FILE")
            echo "Found signature file: $SIG_FILE"
          else
            echo "No signature file found (unsigned build)"
          fi

          # Generate update manifest for auto-updater
          cat > "${WORKSPACE_DIR}/latest.json" << EOF
          {
            "version": "$VERSION",
            "notes": "See the release notes on GitHub",
            "pub_date": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "platforms": {
              "darwin-aarch64": {
                "signature": "$SIGNATURE",
                "url": "https://github.com/anurag-duddu/murmur/releases/download/v$VERSION/Murmur_${VERSION}_macos.app.tar.gz"
              },
              "darwin-x86_64": {
                "signature": "$SIGNATURE",
                "url": "https://github.com/anurag-duddu/murmur/releases/download/v$VERSION/Murmur_${VERSION}_macos.app.tar.gz"
              }
            }
          }
          EOF

      - name: Verify release files exist
        run: |
          echo "=== Files in current directory ==="
          ls -la
          echo "=== Checking expected files ==="
          VERSION="${{ steps.get-version.outputs.version }}"
          for f in "Murmur_${VERSION}_macos.dmg" "Murmur_${VERSION}_macos.app.tar.gz" "latest.json"; do
            if [ -f "$f" ]; then
              echo "✓ Found: $f ($(du -h "$f" | cut -f1))"
            else
              echo "✗ Missing: $f"
            fi
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get-version.outputs.version }}
          name: Murmur v${{ steps.get-version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: false
          body: |
            ## Murmur v${{ steps.get-version.outputs.version }}

            ### Installation
            1. Download `Murmur_${{ steps.get-version.outputs.version }}_macos.dmg`
            2. Open the DMG and drag Murmur to Applications
            3. **First launch**: Right-click the app → Open (to bypass Gatekeeper for unsigned apps)
            4. Grant microphone and accessibility permissions when prompted

            ### What's New
            See [commits since last release](https://github.com/anurag-duddu/murmur/commits/v${{ steps.get-version.outputs.version }})
          files: |
            Murmur_${{ steps.get-version.outputs.version }}_macos.dmg
            Murmur_${{ steps.get-version.outputs.version }}_macos.app.tar.gz
            latest.json
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
