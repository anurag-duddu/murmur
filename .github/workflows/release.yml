name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.0)'
        required: true

env:
  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: get-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm ci

      - name: Update version in tauri.conf.json
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          sed -i '' "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json

      - name: Build Tauri app (unsigned)
        run: npm run tauri build

      - name: List build outputs
        run: |
          echo "=== DMG files ==="
          find src-tauri/target/release/bundle -name "*.dmg" 2>/dev/null || echo "No DMG found"
          echo "=== App bundles ==="
          find src-tauri/target/release/bundle -name "*.app" -type d 2>/dev/null || echo "No .app found"
          echo "=== All bundle contents ==="
          ls -la src-tauri/target/release/bundle/ 2>/dev/null || echo "No bundle dir"
          ls -la src-tauri/target/release/bundle/macos/ 2>/dev/null || echo "No macos dir"
          ls -la src-tauri/target/release/bundle/dmg/ 2>/dev/null || echo "No dmg dir"

      - name: Prepare release artifacts
        id: prepare
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"

          # Find the DMG file (Tauri names it based on version and arch)
          DMG_FILE=$(find src-tauri/target/release/bundle/dmg -name "*.dmg" | head -1)
          if [ -n "$DMG_FILE" ]; then
            cp "$DMG_FILE" "Murmur_${VERSION}_macos.dmg"
            echo "dmg_path=Murmur_${VERSION}_macos.dmg" >> $GITHUB_OUTPUT
          fi

          # Create tar.gz of the .app bundle for auto-updater
          APP_DIR=$(find src-tauri/target/release/bundle/macos -name "*.app" -type d | head -1)
          if [ -n "$APP_DIR" ]; then
            cd src-tauri/target/release/bundle/macos
            tar -czf "../../../../../Murmur_${VERSION}_macos.app.tar.gz" "$(basename "$APP_DIR")"
            cd -
            echo "app_tar_path=Murmur_${VERSION}_macos.app.tar.gz" >> $GITHUB_OUTPUT
          fi

          # Check for signature file (if updater signing is configured)
          if [ -f "src-tauri/target/release/bundle/macos/Murmur.app.tar.gz.sig" ]; then
            SIGNATURE=$(cat src-tauri/target/release/bundle/macos/Murmur.app.tar.gz.sig)
          else
            SIGNATURE=""
          fi

          # Generate update manifest for auto-updater
          cat > latest.json << EOF
          {
            "version": "$VERSION",
            "notes": "See the release notes on GitHub",
            "pub_date": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "platforms": {
              "darwin-aarch64": {
                "signature": "$SIGNATURE",
                "url": "https://github.com/anurag-duddu/murmur/releases/download/v$VERSION/Murmur_${VERSION}_macos.app.tar.gz"
              },
              "darwin-x86_64": {
                "signature": "$SIGNATURE",
                "url": "https://github.com/anurag-duddu/murmur/releases/download/v$VERSION/Murmur_${VERSION}_macos.app.tar.gz"
              }
            }
          }
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get-version.outputs.version }}
          name: Murmur v${{ steps.get-version.outputs.version }}
          draft: false
          prerelease: false
          body: |
            ## Murmur v${{ steps.get-version.outputs.version }}

            ### Installation
            1. Download `Murmur_${{ steps.get-version.outputs.version }}_macos.dmg`
            2. Open the DMG and drag Murmur to Applications
            3. **First launch**: Right-click the app â†’ Open (to bypass Gatekeeper for unsigned apps)
            4. Grant microphone and accessibility permissions when prompted

            ### What's New
            See [commits since last release](https://github.com/anurag-duddu/murmur/commits/v${{ steps.get-version.outputs.version }})
          files: |
            Murmur_${{ steps.get-version.outputs.version }}_macos.dmg
            Murmur_${{ steps.get-version.outputs.version }}_macos.app.tar.gz
            latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
